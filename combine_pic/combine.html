<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Combine PNG Images</title>
    <style>
        body { font-family: sans-serif; margin: 40px; background: #f7f7f7; }
        .container { max-width: 500px; margin: auto; background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px #0001; }
        input[type=file] { margin-bottom: 16px; }
        #preview { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 8px; }
        .thumb { width: 80px; height: 80px; object-fit: contain; border: 1px solid #ccc; border-radius: 6px; background: #eee; }
        #result { margin-top: 24px; }
        button { padding: 8px 20px; border-radius: 6px; border: none; background: #0078d4; color: #fff; font-size: 16px; cursor: pointer; }
        button:disabled { background: #aaa; }
    </style>
</head>
<body>
<div class="container">
    <h2>รวมรูป PNG เป็น 1:1</h2>
    <label>ขนาด export:
        <select id="sizeSelect">
            <option value="square">สี่เหลี่ยม 1:1 (1000x1000px)</option>
            <option value="a4">A4 (2480x3508px)</option>
            <option value="a5">A5 (1748x2480px)</option>
        </select>
    </label>
    <span id="pageSizeDiv" style="display:none; margin-left:10px;">
        <label>จำนวนช่อง/แผ่น: <input type="number" id="pageSizeInput" min="1" max="100" value="9" style="width:60px;"></label>
    </span>
    <br>
    <div id="zoomDiv" style="display:none; margin: 10px 0;">
    <label>Zoom: <input type="range" id="zoomSlider" min="0.5" max="5" step="0.01" value="1"> <span id="zoomValue">1.00x</span></label>
    </div>
    <br>
    <input type="file" id="fileInput" multiple accept="image/png">
    <div id="preview"></div>
    <button id="combineBtn" disabled>รวมและแสดงตัวอย่าง</button>
    <button id="exportAllBtn" style="margin-left:10px; display:none;">Export All Pages</button>
    <div id="result"></div>
</div>
<script>
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const combineBtn = document.getElementById('combineBtn');
const exportAllBtn = document.getElementById('exportAllBtn');
const result = document.getElementById('result');
const sizeSelect = document.getElementById('sizeSelect');
const pageSizeDiv = document.getElementById('pageSizeDiv');
const pageSizeInput = document.getElementById('pageSizeInput');
const zoomDiv = document.getElementById('zoomDiv');
const zoomSlider = document.getElementById('zoomSlider');
const zoomValue = document.getElementById('zoomValue');
let images = [];
let bitmaps = [];
let pages = [];
let currentPage = 0;
let PAGE_SIZE = 9;
let zoom = 1;

sizeSelect.addEventListener('change', () => {
    zoomDiv.style.display = 'block';
    zoomSlider.value = 1;
    zoom = 1;
    zoomValue.textContent = '1.00x';
    if (sizeSelect.value === 'a4' || sizeSelect.value === 'a5') {
        pageSizeDiv.style.display = '';
    } else {
        pageSizeDiv.style.display = 'none';
        pageSizeInput.value = 9;
    }
    showPage(currentPage);
});

zoomSlider.addEventListener('input', () => {
    zoom = parseFloat(zoomSlider.value);
    zoomValue.textContent = zoom.toFixed(2) + 'x';
    showPage(currentPage);
});

fileInput.addEventListener('change', async (e) => {
    preview.innerHTML = '';
    images = Array.from(e.target.files);
    if (images.length > 0) {
        combineBtn.disabled = false;
        images.forEach(file => {
            const img = document.createElement('img');
            img.className = 'thumb';
            img.src = URL.createObjectURL(file);
            preview.appendChild(img);
        });
    } else {
        combineBtn.disabled = true;
    }
    // reset page
    currentPage = 0;
    pages = [];
    bitmaps = [];
    result.innerHTML = '';
    // reset zoom
    zoomSlider.value = 1;
    zoom = 1;
    zoomValue.textContent = '1.00x';
    zoomDiv.style.display = 'block';
});

combineBtn.addEventListener('click', async () => {
    if (images.length === 0) return;
    // โหลดรูปทั้งหมดเป็น ImageBitmap
    bitmaps = await Promise.all(images.map(file => createImageBitmap(file)));
    // กำหนด PAGE_SIZE ตาม input
    if (sizeSelect.value === 'a4' || sizeSelect.value === 'a5') {
        PAGE_SIZE = Math.max(1, Math.min(100, parseInt(pageSizeInput.value) || 9));
    } else {
        PAGE_SIZE = 9;
    }
    // แบ่งหน้า
    pages = [];
    for (let i = 0; i < bitmaps.length; i += PAGE_SIZE) {
        pages.push(bitmaps.slice(i, i + PAGE_SIZE));
    }
    currentPage = 0;
    showPage(currentPage);
    exportAllBtn.style.display = pages.length > 0 ? '' : 'none';
// Export All Pages
exportAllBtn.onclick = () => {
    if (!pages || pages.length === 0) return;
    let canvasWidth = 1000, canvasHeight = 1000;
    switch (sizeSelect.value) {
        case 'a4':
            canvasWidth = 2480; canvasHeight = 3508; break;
        case 'a5':
            canvasWidth = 1748; canvasHeight = 2480; break;
        case 'square':
        default:
            canvasWidth = 1000; canvasHeight = 1000; break;
    }
    const gridSize = Math.ceil(Math.sqrt(PAGE_SIZE));
    pages.forEach((pageBitmaps, idx) => {
        const canvas = document.createElement('canvas');
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const cellW = canvasWidth / gridSize;
        const cellH = canvasHeight / gridSize;
        pageBitmaps.forEach((bmp, i) => {
            const row = Math.floor(i / gridSize);
            const col = i % gridSize;
            let minCell = Math.min(cellW, cellH);
            let drawW = bmp.width;
            let drawH = bmp.height;
            let scale = zoom * (minCell / Math.max(drawW, drawH));
            drawW = drawW * scale;
            drawH = drawH * scale;
            const offsetX = col * cellW + (cellW - drawW) / 2;
            const offsetY = row * cellH + (cellH - drawH) / 2;
            ctx.drawImage(bmp, offsetX, offsetY, drawW, drawH);
        });
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = `combined_page${idx+1}_${sizeSelect.value}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });
};
});

function showPage(pageIdx) {
    if (!pages[pageIdx] || pages[pageIdx].length === 0) return;
    const pageBitmaps = pages[pageIdx];
    const gridSize = Math.ceil(Math.sqrt(PAGE_SIZE));
    // กำหนดขนาด canvas ตามที่เลือก
    let canvasWidth = 1000, canvasHeight = 1000;
    switch (sizeSelect.value) {
        case 'a4':
            canvasWidth = 2480; canvasHeight = 3508; break;
        case 'a5':
            canvasWidth = 1748; canvasHeight = 2480; break;
        case 'square':
        default:
            canvasWidth = 1000; canvasHeight = 1000; break;
    }
    const canvas = document.createElement('canvas');
    canvas.width = canvasWidth;
    canvas.height = canvasHeight;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // ขนาดแต่ละช่อง grid
    const cellW = canvasWidth / gridSize;
    const cellH = canvasHeight / gridSize;
    pageBitmaps.forEach((bmp, i) => {
        const row = Math.floor(i / gridSize);
        const col = i % gridSize;
        let minCell = Math.min(cellW, cellH);
        let drawW = bmp.width;
        let drawH = bmp.height;
        // ทุกโหมดใช้ zoom
        let scale = zoom * (minCell / Math.max(drawW, drawH));
        drawW = drawW * scale;
        drawH = drawH * scale;
        // จัดให้อยู่ตรงกลางช่อง
        const offsetX = col * cellW + (cellW - drawW) / 2;
        const offsetY = row * cellH + (cellH - drawH) / 2;
        ctx.drawImage(bmp, offsetX, offsetY, drawW, drawH);
    });
    // แสดงตัวอย่าง
    result.innerHTML = '';
    const previewImg = document.createElement('img');
    previewImg.src = canvas.toDataURL('image/png');
    previewImg.style.maxWidth = '100%';
    previewImg.style.border = '1px solid #ccc';
    result.appendChild(previewImg);
    // ปุ่มดาวน์โหลด
    const dlBtn = document.createElement('button');
    dlBtn.textContent = 'Export PNG';
    dlBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = `combined_page${pageIdx+1}_${sizeSelect.value}.png`;
        a.click();
    };
    result.appendChild(dlBtn);
    // ปุ่มเปลี่ยนหน้า
    if (pages.length > 1) {
        const nav = document.createElement('div');
        nav.style.marginTop = '16px';
        nav.style.display = 'flex';
        nav.style.justifyContent = 'center';
        nav.style.gap = '12px';
        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'Prev';
        prevBtn.disabled = pageIdx === 0;
        prevBtn.onclick = () => {
            if (currentPage > 0) {
                currentPage--;
                showPage(currentPage);
            }
        };
        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Next';
        nextBtn.disabled = pageIdx === pages.length - 1;
        nextBtn.onclick = () => {
            if (currentPage < pages.length - 1) {
                currentPage++;
                showPage(currentPage);
            }
        };
        const pageInfo = document.createElement('span');
        pageInfo.textContent = `หน้า ${pageIdx+1} / ${pages.length}`;
        nav.appendChild(prevBtn);
        nav.appendChild(pageInfo);
        nav.appendChild(nextBtn);
        result.appendChild(nav);
    }
}
</script>
</body>
</html>
